<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Formations Gamifi√©es ‚Äî Catalogue (v4)</title>
<meta name="description" content="Catalogue multi-formations gamifi√©es ‚Äî monobloc HTML/CSS/JS. Th√®mes, packs JSON, badge PNG + QR, timers, XP, confettis, import/export."/>

<style>
:root{
  --bg:#f6f1e7; --ink:#27312a; --muted:#6d7a71;
  --accent:#2f7f62; --accent2:#b88c2a; --line:#e7dece; --panel:#fffdfa;
  --ok:#2e9b68; --warn:#d9992e; --err:#cc4a4a; --radius:16px; --shadow:0 14px 40px rgba(39,49,42,.12)
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 800px at 70% -10%,#fff7e9 0%, var(--bg) 60%);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.app{max-width:1180px;margin:auto;padding:20px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
h1{margin:0;font-weight:750;font-size:22px;letter-spacing:.2px;display:flex;align-items:center;gap:10px}
.logo{width:32px;height:32px;border-radius:6px;border:1px solid var(--line);background:#fff;object-fit:contain}
.btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s;box-shadow:var(--shadow)}
.btn:hover{transform:translateY(-1px)}
.card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
.grid{display:grid;gap:14px}
.grid.cards{grid-template-columns:repeat(3,1fr)} @media(max-width:980px){.grid.cards{grid-template-columns:1fr 1fr}} @media(max-width:640px){.grid.cards{grid-template-columns:1fr}}
.formation{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
.formation .head{display:flex;gap:10px;align-items:center}
.badge{background:#0b6;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px solid var(--line);padding:2px 6px;border-radius:6px;font-size:.85em}
.muted{color:var(--muted)}
.progress-map{display:flex;align-items:center;gap:10px;margin:8px 0 12px;flex-wrap:wrap}
.step{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff}
.step .dot{width:12px;height:12px;border-radius:999px;background:#d8d8d8;border:1px solid var(--line)}
.step.done .dot{background:var(--accent)} .step.now .dot{background:var(--accent2)}
.connector{height:2px;width:24px;background:linear-gradient(90deg,var(--accent),var(--accent2));opacity:.3}
.list{display:grid;gap:10px}
.module{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;transform:perspective(600px) rotateX(0) rotateY(0);transition:transform .25s,box-shadow .25s}
.module:hover{transform:perspective(600px) rotateX(1.5deg) rotateY(-1.5deg);box-shadow:0 18px 50px rgba(0,0,0,.12)}
.module h3{margin:0 0 6px;font-size:16px;color:var(--accent);font-weight:700}
.meta{font-size:13px;color:var(--muted)}
.q{margin:10px 0;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
label.opt{display:block;margin:6px 0;padding:8px;border:1px solid var(--line);border-radius:10px;cursor:pointer;background:#fff}
.feedback{margin-top:8px;font-size:14px}.ok{color:var(--ok)}.err{color:var(--err)}
.timer{font-variant-numeric:tabular-nums}
.scorebox{display:grid;gap:6px}
.stars{font-size:18px;letter-spacing:1px}
.badge-preview{display:flex;align-items:center;justify-content:center;background:#fff;border:1px dashed var(--line);min-height:140px;border-radius:12px}
.toast{position:fixed;inset:auto 20px 20px auto;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px 12px;color:var(--ink);box-shadow:var(--shadow);opacity:0;transform:translateY(6px);transition:.25s}
.toast.show{opacity:1;transform:none}
#confetti{position:fixed;inset:0;pointer-events:none}
input[type="text"]{background:#fff;border:1px solid var(--line);border-radius:999px;color:var(--ink);padding:6px 10px;outline:none}
input.short{width:220px} textarea{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px}
dialog.modal{border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);max-width:880px;width:clamp(320px,80vw,880px)}
.modal header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);padding:10px 12px}
.modal .body{padding:12px}
textarea.editor{width:100%;height:360px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;font:13px ui-monospace,Menlo,Consolas,monospace}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<div class="app" id="app">
  <header>
    <h1><img id="logoApp" class="logo" alt="Logo" src=""> Formations Gamifi√©es</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span class="muted">Mode : <strong id="modeLabel">Catalogue</strong></span>
      <button class="btn" onclick="UI.gotoCatalog()">Catalogue</button>
      <button class="btn" onclick="UI.openPacks()">+ Ajouter un pack</button>
      <button class="btn" onclick="UI.exportPacks()">Exporter packs</button>
    </div>
  </header>

  <div id="screen" class="grid"></div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<!-- Modale Packs -->
<dialog id="packs" class="modal">
  <header><strong>Gestion des packs (formations)</strong><button class="btn" onclick="document.getElementById('packs').close()">Fermer</button></header>
  <div class="body">
    <p class="muted">Colle un <strong>pack JSON</strong> (id, title, theme, logoData?, sitesUrl?, curriculum). Tu peux en importer plusieurs.</p>
    <textarea id="packArea" class="editor" placeholder='{"id":"ia_enjeux","title":"IA & Enjeux","theme":{"accent":"#2f7f62","accent2":"#b88c2a"},"curriculum":{...}}'></textarea>
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <button class="btn primary" onclick="Packs.saveFromText()">Enregistrer le pack</button>
      <button class="btn" onclick="Packs.importJSON()">Importer .json</button>
      <button class="btn" onclick="Packs.reset()">R√©initialiser aux packs par d√©faut</button>
    </div>
  </div>
</dialog>

<script>
const STORAGE="multi_training_v4";
const Store={data:{packs:[], prefs:{logoApp:""}},load(){try{const raw=localStorage.getItem(STORAGE);if(raw)this.data=JSON.parse(raw);}catch(e){}},save(){localStorage.setItem(STORAGE,JSON.stringify(this.data));},set(k,v){this.data[k]=v;this.save();}};Store.load();

const DEFAULT_PACKS=[{id:"ia_enjeux",title:"Formation IA & Enjeux ‚Äî 2h",description:"Parcours 2h gamifi√© : LLM, prompts, agents, gouvernance.",theme:{accent:"#2f7f62",accent2:"#b88c2a",bg:null},sitesUrl:"",logoData:"",curriculum:{intro:{id:"intro",title:"Introduction (√©nergie & attentes)",goal:"Aligner le cadre, sonder les usages, installer les r√®gles du jeu.",methods:"Pr√©sentation interactive, discussion.",timeMin:10,quiz:[{type:"mcq",q:"Objectif principal de la gamification ici ?",opts:["Augmenter l‚Äôengagement et le feedback en temps r√©el","Remplacer tout le contenu","Allonger la dur√©e"],correct:0,xp:8,explain:"D√©fis courts + retours imm√©diats = meilleure r√©tention."}],challenge:{title:"Pitch √©clair",prompt:"En 120 caract√®res, d√©cris ton principal cas d‚Äôusage IA au travail.",rubric:["clair","concret","impact"]}},modules:[{id:"m1",title:"Module 1 ‚Äî IA & LLM 2025",goal:"Distinguer IA vs logiciels ; cartographier GPT‚Äë5 ; benchmark LLM.",methods:"Quiz, co‚Äëconstruction, mini-expos√©s.",timeMin:25,quiz:[{type:"mcq",q:"Un LLM est surtout‚Ä¶",opts:["Un moteur de pr√©diction de tokens conditionn√© par le contexte","Une base de faits certifi√©s","Un navigateur autonome"],correct:0,xp:8,explain:"Probabiliste, pas base de v√©rit√©."},{type:"mcq",q:"Sortie IA g√©n√©rative vs logiciel classique ?",opts:["D√©terministe","Probabiliste d√©pend du prompt/contexte","Toujours identique"],correct:1,xp:8}],challenge:{title:"Carte des capacit√©s",prompt:"Liste 5 capacit√©s utiles de GPT‚Äë5 pour ton √©quipe (verbe d‚Äôaction + livrable).",rubric:["utile","sp√©cifique","mesurable"]}},{id:"m2",title:"Module 2 ‚Äî Prompt & Orchestration",goal:"Prompts solides ; cha√Ænage ; m√©moire ; √©thique.",methods:"Atelier pratique, feedback.",timeMin:30,quiz:[{type:"mcq",q:"Un prompt m√©tier robuste commence par‚Ä¶",opts:["R√¥le + objectif + contraintes","Des emojis","Un pav√© non structur√©"],correct:0,xp:8,explain:"Ajoute exemples + crit√®res."},{type:"mcq",q:"La 'm√©moire' sert surtout √†‚Ä¶",opts:["Conserver pr√©f√©rences/faits durables","Am√©liorer le style","Remplacer les donn√©es"],correct:0,xp:8}],challenge:{title:"Prompt‚Äëatelier",prompt:"R√©dige un prompt avec r√¥le, objectif, contraintes, 2 exemples, 3 crit√®res d‚Äôacceptation.",rubric:["r√¥le/objectif","exemples","crit√®res"]}},{id:"m3",title:"Module 3 ‚Äî Cr√©ation d‚Äôagents GPT‚Äë5",goal:"Cadrer ; concevoir ; tester ; it√©rer.",methods:"Groupes, tests crois√©s.",timeMin:30,quiz:[{type:"mcq",q:"√âl√©ment NON indispensable pour un agent minimal ?",opts:["R√¥le clair","UI complexe d√©di√©e","Outils/permissions cadr√©s"],correct:1,xp:8,explain:"L‚ÄôUI peut rester minimale."},{type:"mcq",q:"La 'sandbox' de test sert √†‚Ä¶",opts:["√âvaluer prompts/outils","Publier l‚Äôagent","Remplacer la doc"],correct:0,xp:8}],challenge:{title:"Canvas d‚Äôagent",prompt:"Compl√®te : cible, t√¢ches, outils/APIs, permissions, m√©moire, garde-fous. (5 lignes max)",rubric:["cible","outils","garde‚Äëfous"]}},{id:"m4",title:"Module 4 ‚Äî Enjeux & Gouvernance",goal:"Impacts ; RGPD/AI Act ; √©co‚Äëconception.",methods:"Lecture guid√©e, d√©bat, jeu de r√¥le.",timeMin:25,quiz:[{type:"mcq",q:"'Privacy by design' implique‚Ä¶",opts:["Penser la protection d√®s la conception","Banni√®re cookies","Externaliser"],correct:0,xp:8},{type:"mcq",q:"√âco‚Äëconception IA¬†: on vise‚Ä¶",opts:["Toujours plus lourd","Sobri√©t√© selon l‚Äôusage","Ignorer la latence"],correct:1,xp:8}],challenge:{title:"Garde‚Äëfous",prompt:"√âcris 3 r√®gles de bon usage IA adapt√©es √† ton contexte (1 ligne chacune).",rubric:["pratique","proportionn√©e","v√©rifiable"]}}],feedback:{id:"outro",title:"Feedback & suites",goal:"√âvaluer, engagement concret, prochaines √©tapes.",methods:"Questionnaire + debrief.",timeMin:10}}}];

const Packs={list(){return Store.data.packs?.length?Store.data.packs:DEFAULT_PACKS;},saveAll(arr){Store.data.packs=arr;Store.save();UI.toast("Packs sauvegard√©s");},upsert(pack){const arr=this.list().slice();const i=arr.findIndex(p=>p.id===pack.id);if(i>=0)arr[i]=pack;else arr.push(pack);this.saveAll(arr);},get(id){return this.list().find(p=>p.id===id);},reset(){Store.data.packs=[];Store.save();UI.toast("Packs r√©initialis√©s aux valeurs par d√©faut");UI.renderCatalog();},saveFromText(){try{const obj=JSON.parse(document.getElementById("packArea").value);if(!obj.id||!obj.title||!obj.curriculum)throw new Error("Champs requis: id, title, curriculum");this.upsert(obj);document.getElementById('packs').close();UI.renderCatalog();}catch(e){alert("JSON invalide : "+e.message);}},importJSON(){const input=document.createElement("input");input.type="file";input.accept="application/json";input.addEventListener("change",async()=>{const f=input.files?.[0];if(!f)return;try{const txt=await f.text();const obj=JSON.parse(txt);this.upsert(obj);document.getElementById('packs').close();UI.renderCatalog();}catch(e){alert("Import √©chou√© : "+e.message);}});input.click();}};

const UI={el:{},current:null,state:{},init(){this.el.screen=document.getElementById("screen");this.el.mode=document.getElementById("modeLabel");this.el.logoApp=document.getElementById("logoApp");this.el.logoApp.src=Store.data.prefs?.logoApp||"";const url=new URL(location.href);const packId=url.searchParams.get("pack");if(packId&&Packs.get(packId))this.enterPack(packId);else this.renderCatalog();},toast(msg){const t=document.getElementById("toast");t.textContent=msg;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1600);},gotoCatalog(){history.replaceState({}, "", location.pathname);this.renderCatalog();},openPacks(){document.getElementById("packs").showModal();document.getElementById("packArea").value="";},exportPacks(){const blob=new Blob([JSON.stringify(Packs.list(),null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const a=Object.assign(document.createElement("a"),{href:url,download:"packs_formations.json"});a.click();setTimeout(()=>URL.revokeObjectURL(url),800);},renderCatalog(){this.el.mode.textContent="Catalogue";const packs=Packs.list();this.el.screen.className="grid cards";this.el.screen.innerHTML=packs.map(p=>`<div class="formation"><div class="head"><img src="${p.logoData||''}" class="logo" alt=""><div><strong>${p.title}</strong><br><span class="muted">${p.description||""}</span></div></div><div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"><span class="badge" style="background:${(p.theme?.accent||'#2f7f62')}">Pack</span><button class="btn" onclick="UI.enterPack('${p.id}')">Ouvrir</button><button class="btn" onclick="UI.editPack('${p.id}')">√âditer</button><button class="btn" onclick="UI.exportPack('${p.id}')">Exporter</button></div></div>`).join("")+`<div class="formation"><div><strong>+</strong> Nouveau pack</div><p class="muted">Colle un JSON de formation, ou importe un fichier.</p><button class="btn" onclick="UI.openPacks()">+ Ajouter un pack</button></div>`;},exportPack(id){const p=Packs.get(id);const blob=new Blob([JSON.stringify(p,null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const a=Object.assign(document.createElement("a"),{href:url,download:`pack_${id}.json`});a.click();setTimeout(()=>URL.revokeObjectURL(url),800);},editPack(id){const p=Packs.get(id);document.getElementById("packArea").value=JSON.stringify(p,null,2);document.getElementById("packs").showModal();},enterPack(id){const pack=Packs.get(id);if(!pack)return this.renderCatalog();history.replaceState({}, "", `?pack=${encodeURIComponent(id)}`);this.el.mode.textContent=pack.title;if(pack.theme?.accent)document.documentElement.style.setProperty('--accent',pack.theme.accent);if(pack.theme?.accent2)document.documentElement.style.setProperty('--accent2',pack.theme.accent2);if(pack.logoData)document.getElementById("logoApp").src=pack.logoData;this.current={id,pack};this.state=StateFor(id);this.renderPackHome();},renderPackHome(){const p=this.pack();const C=p.curriculum;this.el.screen.className="grid";this.el.screen.innerHTML=`<div class="card"><h2>${p.title}</h2><p class="muted">${p.description||""}</p><div class="progress-map" id="progress-map"></div><div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"><span>Nom¬†: <input id="username" class="short" placeholder="Pr√©nom Nom" value="${this.state.name||""}"></span><span>URL Google Sites¬†: <input id="sitesUrl" class="short" placeholder="https://sites.google.com/..." value="${p.sitesUrl||""}" oninput="UI.updatePackSitesUrl(this.value)"></span><button class="btn" onclick="UI.openPackEditor()">√âditer contenu‚Ä¶</button><button class="btn" onclick="UI.exportProgress()">Exporter progression</button><button class="btn" onclick="UI.importProgress()">Importer progression</button><button class="btn" onclick="UI.gotoCatalog()">‚óÄ Catalogue</button></div></div><div class="card"><h3>Plan & objectifs</h3><div class="list" id="plan"></div></div><div class="card"><h3>Score & badge</h3><progress id="scorebar" max="100" value="0"></progress><div><strong id="scoretext">0</strong>/100 ‚Ä¢ <span class="stars" id="stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span></div><button class="btn" id="btn-badge" disabled>G√©n√©rer le badge PNG (avec QR)</button><div class="badge-preview" id="badge-preview"><small class="muted">Badge aper√ßu apr√®s g√©n√©ration</small></div></div><div class="card" id="screenPack"></div>`;document.getElementById("plan").innerHTML=`${modLink(C.intro)}${C.modules.map(m=>modLink(m)).join("")}${modLink(C.feedback)}`;this.renderMap("home");document.getElementById("username").addEventListener("input",(e)=>{this.state.name=e.target.value;this.persist();});document.getElementById("btn-badge").onclick=()=>Badge.generatePNG(this.state.name||"Participant",this.state.xp,percent(this.state),this.pack().sitesUrl||location.href,this.pack().logoData||"");this.navigate(C.intro.id);},pack(){return this.current.pack;},updatePackSitesUrl(url){this.current.pack.sitesUrl=url;Packs.upsert(this.current.pack);},renderMap(active){const C=this.pack().curriculum;const steps=[{id:C.intro.id,label:"Intro"},...C.modules.map(m=>({id:m.id,label:m.title.replace(/ ‚Äî .+$/,"")})),{id:C.feedback.id,label:"Feedback"}];document.getElementById("progress-map").innerHTML=steps.map((s,i)=>{const done=!!this.state.done[s.id],now=s.id===active;return `<div class="step ${done?"done":""} ${now?"now":""}"><span class="dot"></span><span>${s.label}</span></div>${i<steps.length-1?'<div class="connector"></div>':""}`;}).join("");},navigate(route){const C=this.pack().curriculum;this.renderMap(route);if(route===C.intro.id)return this.renderModule(C.intro);if(route===C.feedback.id)return this.renderOutro();const m=C.modules.find(x=>x.id===route);if(m)return this.renderModule(m);},renderModule(mod){const qHtml=(mod.quiz||[]).map((q,i)=>quizHTML(mod.id,i,q)).join("");const challenge=mod.challenge?challengeHTML(mod):"";const spent=this.state.timeSpent[mod.id]||0,running=!!this.state.timers[mod.id];document.getElementById("screenPack").innerHTML=`<h2>${mod.title}</h2><p><strong>Objectif¬†:</strong> ${mod.goal}</p><p class="muted"><strong>M√©thodes¬†:</strong> ${mod.methods} ‚Ä¢ <strong>Temps indicatif¬†:</strong> ${mod.timeMin}‚Ä≤</p><div class="module" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap"><button class="btn" onclick="UI.toggleTimer('${mod.id}')">${running?"‚è∏Ô∏é Stop":"‚ñ∂Ô∏é D√©marrer"} le minuteur</button><small class="muted">Temps pass√©¬†: <span id="spent_${mod.id}">${fmtMin(spent)}</span></small>${navPrevNext(this.pack().curriculum,mod.id)}</div>${qHtml||`<div class="muted">Aucun quiz d√©fini.</div>`}${challenge}<hr><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn" onclick="UI.navigate('home')">‚óÄ Accueil</button><button class="btn" onclick="UI.complete('${mod.id}', ${mod.timeMin})">Marquer comme termin√©</button></div>`;this.refreshScorebox();},renderOutro(){const C=this.pack().curriculum;document.getElementById("screenPack").innerHTML=`<h2>${C.feedback.title}</h2><p><strong>Objectif¬†:</strong> ${C.feedback.goal}</p><p class="muted"><strong>M√©thodes¬†:</strong> ${C.feedback.methods} ‚Ä¢ <strong>Temps¬†:</strong> ${C.feedback.timeMin}‚Ä≤</p><div class="module"><h3>√âvaluation rapide</h3><label>Ce que tu emportes¬†:<br><textarea id="fb-takeaway" rows="3" placeholder="1 id√©e, 1 pratique, 1 garde‚Äëfou‚Ä¶">${this.state.notes.takeaway||""}</textarea></label><label>Un engagement concret (S.M.A.R.T.)¬†:<br><input id="fb-commit" type="text" placeholder="Ex¬†: 'Tester un agent support sur 10 tickets d‚Äôici 30¬†jours'" value="${this.state.notes.commit||""}"></label><button class="btn" onclick="UI.saveFeedback()">Enregistrer</button></div><hr><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn" onclick="UI.navigate('${C.intro.id}')">‚óÄ Modules</button><button class="btn" onclick="UI.finalize()">Clore la session</button></div>`;this.refreshScorebox();},refreshScorebox(){const p=Math.min(100,Math.round((this.state.xp/this.state.xpMax)*100));const stars=Math.max(0,Math.min(5,Math.round(p/20)));const bar=document.getElementById("scorebar");if(bar)bar.value=p;const st=document.getElementById("scoretext");if(st)st.textContent=p;const s=document.getElementById("stars");if(s)s.textContent="‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".slice(5-stars,10-stars);const btn=document.getElementById("btn-badge");if(btn)btn.disabled=p<50;},toggleTimer(id){if(this.state.timers[id]){const start=this.state.timers[id];delete this.state.timers[id];this.state.timeSpent[id]=(this.state.timeSpent[id]||0)+(Date.now()-start);this.persist();}else{this.state.timers[id]=Date.now();this.persist();}this.renderModule(findMod(this.pack().curriculum,id));},complete(id,timeMin){const spentMin=Math.round(((this.state.timeSpent[id]||0)+(this.state.timers[id]?(Date.now()-this.state.timers[id]):0))/60000);if(this.state.timers[id])this.toggleTimer(id);if(spentMin<=timeMin){animateXP(this.state,6);UI.toast("‚è±Ô∏è Bonus temps (‚â§ indicatif)¬†: +6¬†XP");}this.state.done[id]=true;this.persist();UI.toast("Module marqu√© termin√©");const C=this.pack().curriculum,all=[C.intro.id,...C.modules.map(m=>m.id),C.feedback.id];if(all.every(x=>this.state.done[x]))party();this.refreshScorebox();},saveFeedback(){this.state.notes.takeaway=document.getElementById("fb-takeaway").value.trim();this.state.notes.commit=document.getElementById("fb-commit").value.trim();this.persist();UI.toast("Feedback enregistr√©");},finalize(){const blob=new Blob([JSON.stringify({pack:this.pack().id,summary:summary(this.state),state:this.state},null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const a=Object.assign(document.createElement("a"),{href:url,download:`attestation_${this.pack().id}.json`});a.click();setTimeout(()=>URL.revokeObjectURL(url),800);},exportProgress(){const blob=new Blob([JSON.stringify(this.state,null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const a=Object.assign(document.createElement("a"),{href:url,download:`progress_${this.pack().id}.json`});a.click();setTimeout(()=>URL.revokeObjectURL(url),800);},importProgress(){const input=document.createElement("input");input.type="file";input.accept="application/json";input.addEventListener("change",async()=>{const f=input.files?.[0];if(!f)return;try{const txt=await f.text();const data=JSON.parse(txt);Object.assign(this.state,data);this.persist();this.renderPackHome();}catch(e){alert("Import √©chou√© : "+e.message);}});input.click();},persist(){localStorage.setItem(keyFor(this.pack().id),JSON.stringify(this.state));},openPackEditor(){document.getElementById("packs").showModal();document.getElementById("packArea").value=JSON.stringify(this.pack(),null,2);}};
function keyFor(id){return `${STORAGE}__${id}`;}
function StateFor(id){try{const raw=localStorage.getItem(keyFor(id));if(raw)return JSON.parse(raw);}catch(e){}return {name:"",xp:0,xpMax:100,done:{},startedAt:Date.now(),notes:{},timers:{},timeSpent:{}};}
function modLink(mod){const st=UI.state;const done=st.done?.[mod.id];const dot=done?"‚úÖ":"‚è≥";return `<div class="module"><h3>${dot} ${mod.title}</h3><div class="meta">${mod.goal}</div><div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap"><button class="btn" onclick="UI.navigate('${mod.id}')">Ouvrir</button><small class="meta">${mod.methods} ‚Ä¢ ${mod.timeMin}‚Ä≤</small></div></div>`;}
function navPrevNext(C,id){const ids=[C.intro.id,...C.modules.map(m=>m.id),C.feedback.id];const i=ids.indexOf(id);const prev=i>0?`<button class="btn" onclick="UI.navigate('${ids[i-1]}')">‚óÄ Pr√©c√©dent</button>`:"";const next=i<ids.length-1?`<button class="btn" onclick="UI.navigate('${ids[i+1]}')">Suivant ‚ñ∂</button>`:"";return `<div style="display:flex;gap:8px;flex-wrap:wrap">${prev}${next}</div>`;}
function quizHTML(modId,idx,q){const name=`${modId}_${idx}`;return `<div class="q"><p><strong>Quiz¬†:</strong> ${q.q}</p>${(q.opts||[]).map((o,i)=>`<label class="opt"><input type="radio" name="${name}" value="${i}" onchange="answer('${modId}',${idx},${i})"> ${o}</label>`).join("")}<div class="feedback" id="fb_${name}"></div></div>`;}
function challengeHTML(mod){const id=mod.id;const saved=UI.state.notes?.[id]||"";return `<div class="q"><p><strong>Mini‚Äëd√©fi¬†:</strong> ${mod.challenge.title}</p><p class="muted">${mod.challenge.prompt}</p><textarea id="ch_${id}" rows="4" placeholder="Ta r√©ponse‚Ä¶">${saved}</textarea><div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap"><button class="btn" onclick="evaluateChallenge('${id}')">√âvaluer</button><small class="muted">Bar√®me¬†: ${mod.challenge.rubric.join(" ‚Ä¢ ")}</small></div><div id="chfb_${id}" class="feedback"></div></div>`;}
function findMod(C,id){return id===C.intro.id?C.intro:(id===C.feedback.id?C.feedback:C.modules.find(m=>m.id===id));}
function fmtMin(ms){return `${Math.round((ms||0)/60000)}‚Ä≤`;}
function summary(st){return {user:st.name||null,startedAt:new Date(st.startedAt).toISOString(),elapsedMin:Math.round((Date.now()-st.startedAt)/60000),xp:st.xp,xpMax:st.xpMax,done:Object.keys(st.done),notes:st.notes,timeSpent:st.timeSpent};}
function answer(modId,idx,val){const C=UI.pack().curriculum;const pack=(modId===C.intro.id?C.intro:C.modules.find(m=>m.id===modId));const q=pack.quiz[idx];const ok=Number(val)===Number(q.correct);const fb=document.getElementById(`fb_${modId}_${idx}`);if(ok){fb.innerHTML=`<span class="ok">‚úÖ Correct.</span> ${q.explain||""}`;animateXP(UI.state,q.xp||5);}else{fb.innerHTML=`<span class="err">‚úñ Incorrect.</span> ${q.explain||""}`;}}
function evaluateChallenge(id){const C=UI.pack().curriculum;const mod=findMod(C,id);const text=document.getElementById(`ch_${id}`).value.trim();UI.state.notes[id]=text;UI.persist();const rubric=(mod.challenge?.rubric||[]).map(k=>k.toLowerCase());let score=0;rubric.forEach(k=>{if(text.toLowerCase().includes(k.split("/")[0]))score++;});const ok=score>=Math.max(1,Math.ceil(rubric.length*0.6));document.getElementById(`chfb_${id}`).innerHTML=ok?`<span class="ok">üëç Bien vu.</span> ${score}/${rubric.length} crit√®res. +6¬†XP.`:`<span class="err">ü™´ √Ä affiner.</span> ${score}/${rubric.length} crit√®res. +2¬†XP.`;animateXP(UI.state,ok?6:2);}
let counting=false;function animateXP(st,delta){const start=st.xp;const end=Math.min(st.xpMax,start+(delta||0));st.xp=end;UI.persist();if(delta>=12)spawnConfetti(80);if(counting){UI.refreshScorebox?.();return;}counting=true;const t0=performance.now(),dur=700;function step(t){const k=Math.min(1,(t-t0)/dur);const val=Math.round(start+(end-start)*(0.5-0.5*Math.cos(Math.PI*k)));const el=document.getElementById("scoretext");if(el)el.textContent=Math.min(100,Math.round((val/st.xpMax)*100));if(k<1)requestAnimationFrame(step);else{counting=false;UI.refreshScorebox();}}requestAnimationFrame(step);}
const confettiCanvas=document.getElementById("confetti"),ctxC=confettiCanvas.getContext("2d");let confettiParts=[];
function resizeConfetti(){confettiCanvas.width=innerWidth;confettiCanvas.height=innerHeight;}addEventListener("resize",resizeConfetti);resizeConfetti();
function spawnConfetti(n=120){for(let i=0;i<n;i++){confettiParts.push({x:Math.random()*confettiCanvas.width,y:-20-Math.random()*confettiCanvas.height*0.3,vx:(Math.random()-.5)*2,vy:2+Math.random()*3,r:4+Math.random()*6,a:Math.random()*Math.PI*2,s:(Math.random()>.5?1:-1)*(.02+.03*Math.random()),col:Math.random()<.5?"#2f7f62":(Math.random()<.5?"#b88c2a":"#926b47")});}}
function drawConfetti(){ctxC.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);confettiParts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.a+=p.s;ctxC.save();ctxC.translate(p.x,p.y);ctxC.rotate(p.a);ctxC.fillStyle=p.col;ctxC.fillRect(-p.r/2,-p.r/2,p.r,p.r);ctxC.restore();});confettiParts=confettiParts.filter(p=>p.y<confettiCanvas.height+20);requestAnimationFrame(drawConfetti);}requestAnimationFrame(drawConfetti);
function party(){spawnConfetti(200);UI.toast("üéâ Bravo¬†! Parcours compl√©t√©");}
!function(o){function p(a){this.mode=t.MODE_8BIT_BYTE;this.data=a}function q(a,b){this.typeNumber=a;this.errorCorrectLevel=b;this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[]}
var t={MODE_8BIT_BYTE:4,EC_LEVEL_L:1};
function z(a,b){for(var c=1;c<=10;c++){var d=new q(c,b);d.addData(a);try{d.make();return d}catch(e){} } }
q.prototype={addData:function(a){this.dataList.push(new p(a));this.dataCache=null},isDark:function(a,b){return this.modules[a][b]},getModuleCount:function(){return this.moduleCount},make:function(){this.typeNumber=this.typeNumber||1;this.dataCache=null;for(;;){try{this.makeImpl(!1,0);break}catch(a){this.typeNumber++;if(10<this.typeNumber)throw a;}}},makeImpl:function(){this.moduleCount=this.typeNumber*4+17;this.modules=new Array(this.moduleCount);for(var c=0;c<this.moduleCount;c++){this.modules[c]=new Array(this.moduleCount);for(var d=0;d<this.moduleCount;d++)this.modules[c][d]=null}
this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupTimingPattern();this.dataCache=[1];this.mapData([1],0)},
setupPositionProbePattern:function(a,b){for(var c=-1;7>=c;c++)if(!(0>a+c||this.moduleCount<=a+c))for(var d=-1;7>=d;d++)0>b+d||this.moduleCount<=b+d||(this.modules[a+c][b+d]=0<=c&&c<=6&&(0==d||6==d)||0<=d&&d<=6&&(0==c||6==c)||2<=c&&c<=4&&2<=d&&2<=d)}};
o.QRGen={encode:function(text){var qr=z(text,1);if(!qr)throw Error("Texte trop long pour QR");return qr},drawToCanvas:function(qr,canvas,px){var n=qr.getModuleCount(),ctx=canvas.getContext("2d");canvas.width=canvas.height=n*px;ctx.fillStyle="#fff";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#000";for(var r=0;r<n;r++)for(var c=0;c<n;c++)if(qr.isDark(r,c))ctx.fillRect(c*px,r*px,px,px);}}}(window);
const Badge={generatePNG(name,xp,p,url,logoData){const w=1200,h=700,c=document.createElement("canvas");c.width=w;c.height=h;const ctx=c.getContext("2d");const g=ctx.createLinearGradient(0,0,w,h);g.addColorStop(0,"#fff8ea");g.addColorStop(1,"#f1e6d1");ctx.fillStyle=g;ctx.fillRect(0,0,w,h);ctx.fillStyle="rgba(47,127,98,.18)";for(let i=0;i<7;i++){ctx.beginPath();ctx.arc(120+i*150,110+(i%2)*32,68-(i*4),0,Math.PI*2);ctx.fill();}ctx.strokeStyle="#d8cdbb";ctx.lineWidth=6;ctx.strokeRect(24,24,w-48,h-48);ctx.fillStyle="#27312a";ctx.font="bold 48px system-ui,Segoe UI,Arial";ctx.fillText("Attestation de r√©ussite",60,120);if(logoData){const img=new Image();img.onload=()=>{drawAll(img)};img.src=logoData;}else{drawAll(null);}function drawAll(logo){if(logo){ctx.drawImage(logo,w-160,40,120,120);ctx.strokeStyle="#e1d7c5";ctx.strokeRect(w-160,40,120,120);}ctx.font="bold 40px system-ui,Segoe UI,Arial";ctx.fillStyle="#2f7f62";ctx.fillText(name||"Participant",60,200);const stars="‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".slice(5-Math.round(p/20),10-Math.round(p/20));ctx.font="28px system-ui,Segoe UI,Arial";ctx.fillStyle="#27312a";ctx.fillText(`Score: ${Math.round(p)} / 100 ‚Äî XP: ${xp}`,60,245);ctx.fillText(`√âtoiles: ${stars}`,60,285);const d=new Date();const id=("B-"+d.getFullYear()+(d.getMonth()+1+" ").padStart(2,"0").trim()+ (d.getDate()+"").padStart(2,"0")+"-"+Math.random().toString(36).slice(2,7)).toUpperCase();ctx.font="20px system-ui,Segoe UI,Arial";ctx.fillStyle="#6d7a71";ctx.fillText(`Date: ${d.toLocaleDateString()} ‚Ä¢ Identifiant: ${id}`,60,325);ctx.fillStyle="#b88c2a";ctx.fillRect(w-320,60,240,56);ctx.fillStyle="#fff";ctx.font="bold 26px system-ui";ctx.fillText("Badge Officiel",w-290,97);const qrCanvas=document.createElement("canvas");try{const qr=QRGen.encode((url||location.href).slice(0,100));QRGen.drawToCanvas(qr,qrCanvas,6);const qx=w-320,qy=200,qs=220;ctx.fillStyle="#fff";ctx.fillRect(qx-10,qy-10,qs+20,qs+20);ctx.drawImage(qrCanvas,qx,qy,qs,qs);ctx.font="16px system-ui";ctx.fillStyle="#6d7a71";ctx.fillText("V√©rifier ce badge",qx,qy+qs+28);}catch(e){ctx.fillStyle="#cc4a4a";ctx.fillText("QR non g√©n√©r√©",w-360,180);}ctx.fillStyle="#27312a";ctx.fillText("Formateur¬∑rice:",60,390);ctx.fillText("Organisation:",60,425);ctx.fillText("__________________",200,390);ctx.fillText("__________________",200,425);const urlPng=c.toDataURL("image/png");const a=Object.assign(document.createElement("a"),{href:urlPng,download:`badge_${(name||"participant").toLowerCase().replace(/\s+/g,"_")}.png`});a.click();const imgOut=new Image();imgOut.src=urlPng;imgOut.alt="Badge g√©n√©r√©";imgOut.style.maxWidth="100%";imgOut.style.borderRadius="10px";const prev=document.getElementById("badge-preview");if(prev){prev.innerHTML="";prev.appendChild(imgOut);}spawnConfetti(150);} }
};
function percent(st){return Math.min(100,Math.round((st.xp/st.xpMax)*100));}
window.addEventListener("DOMContentLoaded",()=>UI.init());
</script>
</body>
</html>
